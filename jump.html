<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¬ æ­£åœ¨æ’­æ”¾</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center; /* æ”¹ä¸ºå±…ä¸­ */
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }
  .content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 90vw;
  }
  /* ä¿®æ”¹æ ‡é¢˜ï¼Œè§„é¿æ•æ„Ÿè¯ */
  h1 {
    font-size: 16px;
    margin-bottom: 20px;
    text-align: center;
    opacity: 0.7;
  }
  .video-container {
    position: relative;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5); /* å¢åŠ ä¸€ç‚¹é˜´å½± */
  }
  video {
    width: 100%;
    height: auto;
    border-radius: 12px;
    background: #000;
    display: block; /* é˜²æ­¢åº•éƒ¨å‡ºç°ç©ºéš™ */
  }
  .loading-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); /* ç¨å¾®åŠ æ·±èƒŒæ™¯ */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    pointer-events: none;
    border-radius: 12px;
    z-index: 10; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
  }
  /* Loader CSS ä¿æŒä¸å˜ */
  .loader {
    width: 40px; height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: #00ff88;
    border-radius: 50%;
    animation: spin 1s linear infinite, pulse 1.5s ease-in-out infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,255,136,0.6); }
    50% { box-shadow: 0 0 15px 5px rgba(0,255,136,0.3); }
  }
  .loading-text {
    margin-top: 15px;
    font-size: 14px;
    color: #00ff88;
    letter-spacing: 1px;
    display: flex; align-items: center;
  }
  .dots span {
    opacity: 0; color: #00ff88;
    text-shadow: 0 0 5px #00ff88;
    animation: blink 1.5s infinite;
  }
  .dots span:nth-child(1) { animation-delay: 0s; }
  .dots span:nth-child(2) { animation-delay: 0.3s; }
  .dots span:nth-child(3) { animation-delay: 0.6s; }
  @keyframes blink {
    0%, 20% { opacity: 0; }
    30%, 80% { opacity: 1; }
    100% { opacity: 0; }
  }
  .back-link {
      margin-top: 30px;
      color: #888;
      text-decoration: none;
      font-size: 14px;
      padding: 10px 20px;
      border: 1px solid #444;
      border-radius: 20px;
      transition: all 0.3s;
  }
  .back-link:hover { color: #fff; border-color: #fff; }
  #error-message { color: #ff4444; margin-top: 20px; display: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
</head>
<body>

<div class="content-wrapper">
  <h1>ğŸ¬ æ­£åœ¨æ’­æ”¾...</h1>
  <div class="video-container">
    <video id="video" playsinline webkit-playsinline preload="auto" controls></video>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loader"></div>
      <div class="loading-text">
        è§†é¢‘åŠ è½½ä¸­<span class="dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
  </div>
  <div id="error-message"></div>
  <a href="index.html" class="back-link">â† è¿”å›åˆ—è¡¨</a>
</div>

<script>
const video = document.getElementById('video');
const loadingOverlay = document.getElementById('loadingOverlay');
const errorDiv = document.getElementById('error-message');
let hls = null;

// å·¥å…·å‡½æ•°
function saveProgress(url, time){ if(time > 5) localStorage.setItem("progress_" + url, time.toFixed(1)); }
function loadProgress(url){ const t=parseFloat(localStorage.getItem("progress_" + url)); return isNaN(t)?0:t; }
function showLoading(){ loadingOverlay.style.display='flex'; errorDiv.style.display='none'; }
function hideLoading(){ loadingOverlay.style.display='none'; }
function showError(msg) { hideLoading(); errorDiv.textContent = msg; errorDiv.style.display = 'block'; }

function decodeBase64(str){
  try { return atob(str.replace(/[\r\n\s]/g, "")); }
  catch(e){ console.error("è§£ç å¤±è´¥", e); return ""; }
}

// æ ¸å¿ƒæ’­æ”¾é€»è¾‘
function loadVideo(url, resumeTime, isM3U8){
  if(hls){ hls.destroy(); hls = null; }
  video.pause();
  video.removeAttribute('src');
  video.load(); // é‡ç½® video å…ƒç´ çŠ¶æ€

  if(isM3U8 && typeof Hls !== 'undefined' && Hls.isSupported()){
    console.log("Using Hls.js");
    hls = new Hls({
      maxBufferLength: 30,
      maxMaxBufferLength: 60,
      fragLoadingTimeOut: 25000, // ç¨å¾®å¢åŠ è¶…æ—¶æ—¶é—´
      manifestLoadingTimeOut: 25000,
      enableWorker: true,
      startFragPrefetch: true
    });
    hls.loadSource(url);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      if(resumeTime > 0) {
          console.log("Resuming from:", resumeTime);
          video.currentTime = resumeTime;
      }
      // å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼Œå¤„ç†æµè§ˆå™¨é™åˆ¶
      const playPromise = video.play();
      if (playPromise !== undefined) {
          playPromise.then(_ => hideLoading())
          .catch(error => {
              console.warn("Auto-play prevented:", error);
              hideLoading();
              // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå·¨å¤§çš„æ’­æ”¾æŒ‰é’®è®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹
          });
      } else {
        hideLoading();
      }
    });

    hls.on(Hls.Events.ERROR, function(event, data){
      console.error("Hls.js error:", data);
      if(data.fatal){
        switch(data.type){
          case Hls.ErrorTypes.NETWORK_ERROR:
            console.warn("ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°åŠ è½½...");
            hls.startLoad();
            break;
          case Hls.ErrorTypes.MEDIA_ERROR:
            console.warn("åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤...");
            hls.recoverMediaError();
            break;
          default:
            showError("è§†é¢‘åŠ è½½å‘ç”Ÿä¸å¯æ¢å¤é”™è¯¯");
            hls.destroy();
            break;
        }
      }
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl') || !isM3U8) {
    // åŸç”Ÿæ”¯æŒ HLS (Safari) æˆ–æ™®é€š MP4
    console.log("Using native playback");
    video.src = url;
    video.addEventListener('loadedmetadata', function onLoaded(){
        video.removeEventListener('loadedmetadata', onLoaded);
        if(resumeTime > 0) video.currentTime = resumeTime;
        video.play().catch(e => console.warn("Auto-play prevented", e));
        hideLoading();
    });
    video.addEventListener('error', (e) => showError("è§†é¢‘åŠ è½½å¤±è´¥"));
  } else {
    showError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾æ­¤è§†é¢‘æ ¼å¼");
  }

  // ç»‘å®šè¿›åº¦ä¿å­˜äº‹ä»¶
  video.removeEventListener('timeupdate', video._saveHandler);
  video._saveHandler = ()=>saveProgress(url, video.currentTime);
  video.addEventListener('timeupdate', video._saveHandler);
}

// åˆå§‹åŒ–å…¥å£
function init(){
  showLoading();
  // 1. è·å– URL å‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  const encStr = urlParams.get('v');

  if(!encStr){
      showError("æœªæ‰¾åˆ°è§†é¢‘åœ°å€å‚æ•°ï¼Œè¯·è¿”å›åˆ—è¡¨é¡µé‡æ–°è¿›å…¥ã€‚");
      return;
  }

  // 2. è§£ç åœ°å€
  const url = decodeBase64(encStr.trim());
  if(!url || !url.startsWith('http')){
       showError("è§†é¢‘åœ°å€æ— æ•ˆã€‚");
       return;
  }

  console.log("Ready to load:", url);
  const isM3U8 = url.includes(".m3u8");
  
  // 3. è¯»å–è¿›åº¦å¹¶åŠ è½½
  // ä½¿ç”¨è§£ç åçš„ URL ä½œä¸º keyï¼Œè¿™æ ·å³ä½¿ Base64 å˜äº†åªè¦æœ€ç»ˆåœ°å€ä¸€æ ·å°±èƒ½ç»­æ’­
  const resumeTime = loadProgress(url); 
  loadVideo(url, resumeTime, isM3U8);
}

// é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
document.addEventListener('DOMContentLoaded', init);

video.addEventListener('playing', hideLoading);
video.addEventListener('waiting', showLoading); // ç¼“å†²æ—¶æ˜¾ç¤º loading
video.addEventListener('canplay', hideLoading);
</script>
</body>
</html>